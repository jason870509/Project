<!DOCTYPE html>

<html>

<head>
  <style>
    #info {
      position: absolute;
      top: 0px;
      width: 100%;
      padding: 10px;
      text-align: center;
      color: #ffff00
    }

    body {
      overflow: hidden;
    }
  </style>
</head>

<body>

  <div id="info">Dancing Man<br>
    <button id="play" style="width:10%">Dance</button><br>
    <select name="dance" id="dance">
      <option value="dance4Keys">Please select dance</option>
      <option value="walkKeys">walk(default)</option>
      <option value="jumpKeys">jump</option>
      <option value="dance1Keys">dance-1</option>
      <option value="dance3Keys">dance-2</option>
      <option value="dance4Keys">dance-3</option>
    </select>
  </div>
  <script src="./js/three.js"></script>
  <script src="./js/OrbitControls.js"></script>
  <script src="./js/dat.gui.min.js"></script>
  <script src="./js/KeyboardState.js"></script>
  <script src="./js/jquery-2.1.4.min.js"></script>
  <audio id="soundtrack" autoplay loop style="display:none">
    <source src="sounds/rock_you.mp3" type='audio/wav'>
  </audio>
  <script src="buildModel.js"></script>
  <script src="./dance/walk.js"></script>
  <script src="./dance/jump.js"></script>
  <script src="./dance/dance-1.js"></script>
  <script src="./dance/dance-3.js"></script>
  <script src="./dance/dance-4.js"></script>
  <script>

    var guiNameString = ['bodyX', 'bodyY', 'bodyZ', 'bodyRX', 'bodyRY', 'bodyRZ', 'upperBodyX', 'rightUpperArmX',
      'rightUpperArmZ', 'rightLowerArmX', 'rightLowerArmZ', 'leftUpperArmX', 'leftUpperArmZ', 'leftLowerArmX',
      'leftLowerArmZ', 'rightUpperLegX', 'rightUpperLegZ', 'rightLowerLegX', 'rightLowerLegZ', 'leftUpperLegX',
      'leftUpperLegZ', 'leftLowerLegX', 'leftLowerLegZ', 'rightFeetX', 'leftFeetX', 'rightHandY', 'leftHandY',
      'rightHandX', 'leftHandX']

    var clock = new THREE.Clock();
    var ts = clock.getElapsedTime();
    var intKey = [];
    var isPaused = false;
    var dacne = 1;

    var soundTrack;
    var isPaused = false;
    var isDimming = false, soundVal = 1.0, sign = 1.0;

    var scene, renderer, camera, controls;
    var gcontrol;
    var body, torso;
    var leftUpperArmGroup, leftLowerArmGroup, rightUpperArmGroup, rightLowerArmGroup;
    var leftUpperLegGroup, leftLowerLegGroup, rightUpperLegGroup, rightLowerLegGroup;
    var lefttHandGroup, rightHandGroup, leftFeetGroup, rightFeetGroup;

    clock.stop();

    $('#play').click(function () {
      isPaused = !isPaused;

      if (isPaused) {
        clock.start();
        soundTrack.play();
        $('#play').text('Dance');
      }
      else {
        clock.stop();
        soundTrack.pause();
        $('#play').text('GUI');
      }
    });


    init();
    animate();

    function init() {
      soundTrack = document.getElementById('soundtrack');
      soundTrack.pause();

      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 10000);
      camera.position.y = 200;
      camera.position.z = 500;

      renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x888888);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      document.body.appendChild(renderer.domElement);

      light = new THREE.PointLight(0x888888);
      light.position.set(0, 300, 0);
      scene.add(light);

      var amblight = new THREE.AmbientLight(0x444444); // soft white light
      scene.add(amblight);

      var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
      //scene.add(gridXZ);
      gridXZ.position.y = -50
      //////////////////////////////////////////////////////////////////////////////
      var floor = new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000), new THREE.MeshPhongMaterial({ color: 0x888888, side: THREE.DoubleSide }));
      floor.rotation.x = Math.PI / 2;
      scene.add(floor);

      // Body
      body = new THREE.Object3D();
      upperBodyGroup = buildUpperTorso();
      lowerBodyGroup = buildLowerTorso();
      body.add(upperBodyGroup, lowerBodyGroup);
      scene.add(body);

      // Left Arm
      var armGroup = buildArm();
      leftUpperArmGroup = armGroup[0];
      leftUpperArmGroup.position.set(30, 33, 0);
      leftLowerArmGroup = armGroup[1];
      leftHandGroup = armGroup[2];


      // Right Arm
      var armGroup = buildArm();
      rightUpperArmGroup = armGroup[0];
      rightUpperArmGroup.position.set(-30, 33, 0);
      rightLowerArmGroup = armGroup[1];
      rightHandGroup = armGroup[2];

      // Left Leg
      var legGroup = buildLeg();
      leftUpperLegGroup = legGroup[0];
      leftUpperLegGroup.position.set(15, -33, 0);
      leftLowerLegGroup = legGroup[1];
      leftFeetGroup = legGroup[2];

      // Right Leg
      var legGroup = buildLeg();
      rightUpperLegGroup = legGroup[0];
      rightUpperLegGroup.position.set(-15, -33, 0);
      rightLowerLegGroup = legGroup[1];
      rightFeetGroup = legGroup[2];

      // Head
      headGroup = buildHead();

      upperBodyGroup.add(headGroup, leftUpperArmGroup, rightUpperArmGroup);
      lowerBodyGroup.add(leftUpperLegGroup, rightUpperLegGroup);
      //gcontrol

      gcontrol = {
        // Body
        bodyX: 0.01,
        bodyY: 128.1,
        bodyZ: 0.1,
        bodyRX: 0.001,
        bodyRY: 0.001,
        bodyRZ: 0.001,
        upperBodyX: 0.1,
        // Right Arm
        rightUpperArmX: 0.01,
        rightUpperArmZ: 0.01,
        rightLowerArmX: 0.01,
        rightLowerArmZ: 0.01,
        // Left Arm
        leftUpperArmX: 0.01,
        leftUpperArmZ: 0.01,
        leftLowerArmX: 0.01,
        leftLowerArmZ: 0.01,
        // Right Leg
        rightUpperLegX: 0.01,
        rightUpperLegZ: 0.01,
        rightLowerLegX: 0.01,
        rightLowerLegZ: 0.01,
        // Left Leg
        leftUpperLegX: 0.01,
        leftUpperLegZ: 0.01,
        leftLowerLegX: 0.01,
        leftLowerLegZ: 0.01,
        // Feet
        rightFeetX: 0.01,
        leftFeetX: 0.01,
        // Hand
        rightHandY: 0.1,
        leftHandY: 0.1,
        rightHandX: 0.1,
        leftHandX: 0.1
      };

      var gui = new dat.GUI({
        load: loadJSON(),
        //preset: "run"
      });

      gui.domElement.id = 'gui';
      gui.remember(gcontrol);
      // Body
      gui.add(gcontrol, 'bodyX', -100, 100);
      gui.add(gcontrol, 'bodyY', -10, 200);
      gui.add(gcontrol, 'bodyZ', -100, 100);
      gui.add(gcontrol, 'bodyRX', -3, 3);
      gui.add(gcontrol, 'bodyRY', -3, 3);
      gui.add(gcontrol, 'bodyRZ', -3, 3);
      gui.add(gcontrol, 'upperBodyX', -3, 1.5);
      // Right Arm
      gui.add(gcontrol, 'rightUpperArmX', -3, 1.5);
      gui.add(gcontrol, 'rightUpperArmZ', -2.5, 1.5);
      gui.add(gcontrol, 'rightLowerArmX', -3, 0.1);
      gui.add(gcontrol, 'rightLowerArmZ', -3, 3);
      // Left Arm
      gui.add(gcontrol, 'leftUpperArmX', -3, 1.5);
      gui.add(gcontrol, 'leftUpperArmZ', -2.5, 1.5);
      gui.add(gcontrol, 'leftLowerArmX', -3, 0.1);
      gui.add(gcontrol, 'leftLowerArmZ', -3, 3);
      // Right Leg
      gui.add(gcontrol, 'rightUpperLegX', -3, 1.5);
      gui.add(gcontrol, 'rightUpperLegZ', -2.5, 1.5);
      gui.add(gcontrol, 'rightLowerLegX', 0.1, 3);
      gui.add(gcontrol, 'rightLowerLegZ', -0.5, 1.7);
      // Left Leg
      gui.add(gcontrol, 'leftUpperLegX', -3, 1.5);
      gui.add(gcontrol, 'leftUpperLegZ', -2.5, 1.5);
      gui.add(gcontrol, 'leftLowerLegX', 0.1, 3);
      gui.add(gcontrol, 'leftLowerLegZ', -0.5, 1.7);
      // Feet
      gui.add(gcontrol, 'rightFeetX', -3, 3);
      gui.add(gcontrol, 'leftFeetX', -3, 3);
      // Hand
      gui.add(gcontrol, 'rightHandY', -3, 3);
      gui.add(gcontrol, 'leftHandY', -3, 3);
      gui.add(gcontrol, 'rightHandX', -3, 3);
      gui.add(gcontrol, 'leftHandX', -3, 3);

    }

    function keyframe(t) {

      var keys = eval(document.getElementById("dance").value);
      var s = ((t - ts) % T) / T;

      for (var i = 1; i < keys.length; i++) {
        if (keys[i][0] > s) { break; }
      }

      var ii = i - 1;
      var a = (s - keys[ii][0]) / (keys[ii + 1][0] - keys[ii][0]);
      var forwordKey = 'keys[ii][1].', backwardKey = 'keys[ii + 1][1].';

      for (j = 0; j < guiNameString.length; j++) {
        intKey[j] = eval(forwordKey + guiNameString[j]) * (1 - a) + eval(backwardKey + guiNameString[j]) * a;
      }

    }


    function animate() {


      if (isPaused) {
        soundVal += sign * 0.01;
        soundVal = THREE.Math.clamp(soundVal, 0, 1);
        soundtrack.volume = soundVal;

        keyframe(clock.getElapsedTime());

        // Body
        body.position.x = intKey[0] + 20;
        body.position.y = intKey[1];
        body.position.z = intKey[2];
        body.eulerOrder = 'XZY';
        body.rotation.x = intKey[3];
        body.rotation.y = intKey[4];
        body.rotation.z = intKey[5];
        upperBodyGroup.rotation.x = intKey[6];
        // Right Arm
        rightUpperArmGroup.rotation.x = intKey[7];
        rightUpperArmGroup.rotation.z = intKey[8];
        rightLowerArmGroup.rotation.x = intKey[9];
        rightLowerArmGroup.rotation.z = intKey[10];
        // Left Arm
        leftUpperArmGroup.rotation.x = intKey[11];
        leftUpperArmGroup.rotation.z = intKey[12];
        leftLowerArmGroup.rotation.x = intKey[13];
        leftLowerArmGroup.rotation.z = intKey[14];
        // Right Leg
        rightUpperLegGroup.rotation.x = intKey[15];
        rightUpperLegGroup.rotation.z = intKey[16];
        rightLowerLegGroup.rotation.x = intKey[17];
        rightLowerLegGroup.rotation.z = intKey[18];
        // Left Leg
        leftUpperLegGroup.rotation.x = intKey[19];
        leftUpperLegGroup.rotation.z = intKey[20];
        leftLowerLegGroup.rotation.x = intKey[21];
        leftLowerLegGroup.rotation.z = intKey[22];
        // Feet
        rightFeetGroup.rotation.x = intKey[23];
        leftFeetGroup.rotation.x = intKey[24];
        // Hand
        rightHandGroup.rotation.y = intKey[25];
        leftHandGroup.rotation.y = intKey[26];
        rightHandGroup.rotation.x = intKey[27];
        leftHandGroup.rotation.x = intKey[28];
      }
      else {
        body.eulerOrder = 'XZY';
        body.position.x = gcontrol.bodyX;
        body.position.y = gcontrol.bodyY;
        body.position.z = gcontrol.bodyZ;
        body.rotation.x = gcontrol.bodyRX;
        body.rotation.y = gcontrol.bodyRY;
        body.rotation.z = gcontrol.bodyRZ;
        upperBodyGroup.rotation.x = gcontrol.upperBodyX;
        leftUpperArmGroup.rotation.x = gcontrol.leftUpperArmX;
        leftUpperArmGroup.rotation.z = gcontrol.leftUpperArmZ;
        leftLowerArmGroup.rotation.x = gcontrol.leftLowerArmX;
        leftLowerArmGroup.rotation.z = gcontrol.leftLowerArmZ;
        rightUpperArmGroup.rotation.x = gcontrol.rightUpperArmX;
        rightUpperArmGroup.rotation.z = gcontrol.rightUpperArmZ;
        rightLowerArmGroup.rotation.x = gcontrol.rightLowerArmX;
        rightLowerArmGroup.rotation.z = gcontrol.rightLowerArmZ;
        leftUpperLegGroup.rotation.x = gcontrol.leftUpperLegX;
        leftUpperLegGroup.rotation.z = gcontrol.leftUpperLegZ;
        leftLowerLegGroup.rotation.x = gcontrol.leftLowerLegX;
        leftLowerLegGroup.rotation.z = gcontrol.leftLowerLegZ;
        rightUpperLegGroup.rotation.x = gcontrol.rightUpperLegX;
        rightUpperLegGroup.rotation.z = gcontrol.rightUpperLegZ;
        rightLowerLegGroup.rotation.x = gcontrol.rightLowerLegX;
        rightLowerLegGroup.rotation.z = gcontrol.rightLowerLegZ;
        leftFeetGroup.rotation.x = gcontrol.leftFeetX;
        rightFeetGroup.rotation.x = gcontrol.rightFeetX;
        rightHandGroup.rotation.y = gcontrol.rightHandY;
        leftHandGroup.rotation.y = gcontrol.leftHandY;
        rightHandGroup.rotation.x = gcontrol.rightHandX;
        leftHandGroup.rotation.x = gcontrol.leftHandX;
      }

      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

  </script>
</body>

</html>